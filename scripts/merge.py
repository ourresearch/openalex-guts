import argparse
from sqlalchemy import orm
from os import getenv
from urllib.parse import urlparse
from time import time
import datetime

import models
from app import db

from util import elapsed

# python -m scripts.merge venue --away=2764397475 --into=190099528

journal_bulk_merge_data = [(943657917,4847439),
(2764676403,6556808),
(115101109,8802318),
(106388446,23975315),
(176969771,34379508),
(139980136,40248255),
(186408552,61175029),
(2764596244,62401924),
(10997036,64800834),
(140098354,66051165),
(2764958877,74940757),
(123664738,76898383),
(162814455,81881469),
(2765055348,84712235),
(2764421709,98831239),
(2764961798,100662317),
(34379508,106388446),
(70656719,106963461),
(134701659,109108137),
(4210189560,112095004),
(2755061384,113298455),
(14326310,113867935),
(2764898645,114898993),
(109402044,115104844),
(83672204,119003425),
(32186209,121340927),
(2764600234,129774891),
(2764456582,131264395),
(2764944951,131800149),
(61721701,153217397),
(4210240622,153839015),
(2764732791,161883588),
(2764828677,162357988),
(983123445,175946340),
(84712235,176969771),
(2764767103,177107850),
(84304437,181117821),
(83124626,182681858),
(2764616445,185031775),
(2764346923,185414053),
(9600302,189894822),
(2764397475,190099528),
(40248255,192592622),
(81203986,193587041),
(73464505,202606351),
(2764980871,2736919976),
(2764957029,2736971889),
(2764693523,2737568815),
(181814912,2738023707),
(2764344612,2739149530),
(2764385995,2739289825),
(2756317149,2751239756),
(2764457046,2752473405),
(983721078,2756314272),
(2764680160,2764374073),
(2739365064,2764396440),
(2764574304,2764422958),
(2738760544,2764424419),
(2737985536,2764536361),
(2737649503,2764536579),
(2764647868,2764545194),
(114280229,2764600758),
(2764624126,2764619794),
(2737689800,2764685603),
(2736913947,2764698611),
(2765074581,2764868871),
(2737760926,2764909843),
(1024172067,2764929848),
(2738518496,2765000849),
(2764398715,2765004438),
(2764386878,2765039711),
(2764363797,2898222998),
(2764950441,2947334459),
(4210185749,4210210814),
(2764397475,190099528),
(2764473308,2755380548),
(69999400,175353829),
(101670510,15272795),
(138031900,62796702),
(175757500,180901878),
(185068920,88847514),
(197840130,84680275),
(123664738,76898383),
(2738432268,2764844089),
(2738822768,2764440303),
(2754849392,2754136059),
(2764652268,194983457),
(2764894408,194983457),
(2764899718,2764435153),
(2764797638,70869226),
(2765017128,2764731595),
(2764987508,89660639),
(2898537808,48019687),
(2765007418,93119312),
(2737533559,2764492204),
(176969771,34379508),
(2737577599,2738758080),
(2764869839,2500738039),
(2764885469,135086837),
(2898341049,2898337330),
(3012637879,2764489546),
(10436352,2737415723),
(39501252,87833602),
(2764344310,10668961),
(200575692,48492747),
(2764912760,2764373018),
(2764966490,2764738299),
(2765017390,2764799362),
(26804763,2739014637),
(205800633,168828829),
(66781343,2764812070),
(2737268621,2764823199),
(86406033,2764458511),
(2754055101,2898261664),
(2755565801,2764572307),
(2764506771,191032393),
(2764524801,2764892346),
(135756603,82754758),
(201111873,2765074379),
(2764456391,21749381),
(2764597931,192243282),
(2764710881,47679038),
(100370944,34395325),
(125446444,141475571),
(149002014,2898414893),
(190400154,20489460),
(2736681092,2755293801),
(2764440952,147556662),
(2764826312,2764849710),
(2764840252,2764818234),
(2764971982,141734234),
(168196095,2734502824),
(2736044613,198031716),
(92229565,13549255),
(179185985,166351637),
(2499571333,170816358),
(2736344953,2764564403),
(2737163273,1025827383),
(2738057413,2764456253),
(2764634243,8983540),
(2764676403,6556808),
(2764757583,2764509984),
(2764925253,177137575),
(1035066546,2739265787),
(2736815974,204467137),
(2764406834,2739414406),
(2764584564,2764783919),
(30054516,197285354),
(106388446,23975315),
(139980136,40248255),
(159813646,2764507000),
(2739090814,2754434121),
(2764435184,2764606495),
(2764680234,105183386),
(2765046114,110757056),
(2765057534,129807020),
(28176437,107361000),
(2764397865,114801684),
(2764770975,2764678526),
(2764865975,82475071),
(92158587,188327243),
(943657917,4847439),
(2736290825,58136343),
(2738994455,2738788686),
(2764447915,2737584908),
(2764690235,102349131),
(2737675296,2764952921),
(2738505746,2765023813),
(2764496776,2915010491),
(2764584436,165997068),
(2764702576,26432035),
(2764831156,107914479),
(1030498949,51527640),
(2764529287,2764887550),
(8989879,2764610068),
(18458969,3207227496),
(28614969,2765074505),
(115101109,8802318),
(2764577677,207442143),
(2764957627,2764521147),
(2737993549,2764438471)
]

def run(entity, merge_away_id, merge_into_id):
    if entity == "venue":
        my_class = models.Venue

    now = datetime.datetime.utcnow().isoformat()

    merge_away_obj = my_class.query.options(orm.Load(my_class).raiseload('*')).get(merge_away_id)
    merge_into_obj = my_class.query.options(orm.Load(my_class).raiseload('*')).get(merge_into_id)
    print(f"merging {merge_away_obj} \n away into {merge_into_obj}")

    merge_into_obj.paper_count += merge_away_obj.paper_count
    merge_into_obj.paper_family_count += merge_away_obj.paper_family_count # column can go away after MAG format done
    merge_into_obj.citation_count += merge_away_obj.citation_count
    merge_into_obj.full_updated_date = now

    merge_away_obj.merge_into_id = merge_into_id
    merge_away_obj.merge_into_date = now
    merge_away_obj.updated_date = now
    merge_away_obj.paper_count = 0
    merge_away_obj.paper_family_count = 0  # column can go away after MAG format done
    merge_away_obj.citation_count = 0
    merge_away_obj.full_updated_date = now

    if entity == "venue":
        work_objects = models.Work.query.options(orm.Load(models.Work).raiseload('*')).filter(models.Work.journal_id==merge_away_id).all()
        print(f"updating journal_id for {len(work_objects)} works")
        for work_obj in work_objects:
            work_obj.journal_id = merge_into_id
            work_obj.updated_date = now
            work_obj.full_updated_date = now

    db.session.commit()
    print("done\n")



if __name__ == '__main__':
    # ap = argparse.ArgumentParser()
    # ap.add_argument('entity', help='one of:  work, author, venue, institution (concepts not merged)')
    # ap.add_argument('--away', '-a', nargs='?', type=int, help='ID of entity to merge away')
    # ap.add_argument('--into', '-i', nargs='?', type=int, help='ID of entity to merge into')
    #
    # parsed = ap.parse_args()
    # run(parsed.entity, parsed.away, parsed.into)

    for (away, into) in journal_bulk_merge_data:
        run("venue", away, into)
